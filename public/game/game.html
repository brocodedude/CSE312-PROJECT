<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    <script src="https://cdn.socket.io/4.3.1/socket.io.min.js"></script>
    <title>Lets play a game</title>
</head>
<body>
<script>
    const lobbyId = "{{lobby}}";
    const userId = "{{user}}";

    let allPlayers = {};

    const socket = io();

    // default socket io connection message
    socket.on('connect', () => {
        socket.emit('join', {'lobbyId': lobbyId, 'userId': userId})
        console.log('Connected')
    })

    socket.on('set', handleJoin)
    socket.on('pos', handlePos)
    socket.on('dis', handleDis)
    socket.on('pellet', function (msg) {
        console.log('Pellet eaten')
    })

    function handleJoin(msg) {
        let json = JSON.parse(msg);
        if (!json.spriteType) {
            throw new Error("No sprite id found")
        }
        allPlayers[json.playerid] = json
        setUserNameText(json.spriteType, json.user)
    }

    function handleDis(msg) {
        const json = JSON.parse(msg);
        console.log('disconnect')
        console.log(json.playerid)
        delete allPlayers[json.playerid]
        setUserNameText(json.spriteType, '')
    }

    function handlePos(msg) {
        let json = JSON.parse(msg);
        let spriteId = json.spriteType
        // update player
        allPlayers[json.id] = json

        if (playerSprites[spriteId].playerInfo === null) {
            console.log('Client not ready')
            return
        }

        // update other player sprites
        playerSprites[spriteId].playerInfo.x = json.x
        playerSprites[spriteId].playerInfo.y = json.y
        // update other player username text
        setUserNameTextPos(spriteId)

        try {
            playerSprites[spriteId].playerInfo.anims.play(json.spriteAnim, true)
        } catch (e) {
            // if invalid anim default to neutral image
            playerSprites[spriteId][0].anims.play()
        }
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // main game

    // helper variables
    let cursors;

    // mapped sprite id with:
    // playerInfo
    // default anim
    // anim base so that we can add direction
    // start pos : {x, y}
    /**
     *
     * @type {{gh2: {playerInfo: null, animBase: string, userNameTextPos: null, defaultAnim: string, startPos: number[]}, gh1: {playerInfo: null, animBase: string, userNameTextPos: null, defaultAnim: string, startPos: number[]}, gh3: {playerInfo: null, animBase: string, userNameTextPos: null, defaultAnim: string, startPos: number[]}, pcm: {playerInfo: null, animBase: string, userNameTextPos: null, defaultAnim: string, startPos: number[]}}}
     */
    let playerSprites = {
        'pcm': {
            playerInfo: null,
            defaultAnim: 'pacmanDefault',
            animBase: 'pacman',
            startPos: [400, 100],
            userNameTextPos: null,
        },
        'gh1': {
            playerInfo: null,
            defaultAnim: 'ghostRedNorth',
            animBase: 'ghostRed',
            startPos: [400, 200],
            userNameTextPos: null,
        },
        'gh2': {
            playerInfo: null,
            defaultAnim: 'ghostBlueNorth',
            animBase: 'ghostBlue',
            startPos: [400, 300],
            userNameTextPos: null,
        },
        'gh3': {
            playerInfo: null,
            defaultAnim: 'ghostPinkNorth',
            animBase: 'ghostPink',
            startPos: [400, 400],
            userNameTextPos: null,
        },
    }

    const userNameOffSetX = 55
    const userNameOffSetY = 40
    // movement
    const movementSpeed = -160

    /**
     *  @type {?Phaser.Tilemaps.TilemapLayer} mapLayer
     */
    let mapLayer
    /**
     *  @type {?Phaser.Tilemaps.TilemapLayer} mapLayer
     */
    let pelletLayer

    const config = {
        type: Phaser.AUTO,
        width: window.innerWidth,
        height: window.innerHeight,
        backgroundColor: 0x000000,
        physics: {
            default: 'arcade',
            arcade: {
                gravity: 0,
                debug: true
            }
        },
        scale: {
            mode: Phaser.Scale.FIT,
            autoCenter: Phaser.Scale.CENTER_BOTH,
            parent: 'thegame'
        },
        scene: {
            preload: preload,
            create: create,
            update: update
        }
    };


    const game = new Phaser.Game(config);

    function preload() {
        // sprite sheets
        this.load.spritesheet("pacman", "assets/pacmanSpriteSheet.png", {
            frameWidth: 50,
            frameHeight: 50,
        });
        this.load.spritesheet("ghosts", "assets/ghosts.png", {
            frameWidth: 50,
            frameHeight: 50,
        });
        this.load.spritesheet("fruits", "assets/fruits.png", {
            frameWidth: 50,
            frameHeight: 50,
        });
        this.load.image('secondTile', 'assets/secondTile.png')
        this.load.image('forthTile', 'assets/forthTile.png')
        this.load.image('centrepoint', 'assets/centrepoint.png')

        this.load.tilemapTiledJSON('map', "assets/map.json");
    }

    function create() {
        // keyboard detect
        cursors = this.input.keyboard.createCursorKeys();

        // Set Map
        createMap(this)

        // create animations
        pacmanAnimInit(this)
        ghostsAnimInit(this)

        // load in initial sprites
        for (let playerType in playerSprites) {
            const sprite = playerSprites[playerType]
            const defaultAnim = sprite.defaultAnim
            const startPos = sprite.startPos

            let tmp = this.physics.add.sprite(
                startPos[0],
                startPos[1],
                playerType === 'pcm' ? 'pacman' : 'ghosts'
            );

            tmp.anims.play(defaultAnim);
            tmp.setOrigin(0.5);
            tmp.setCollideWorldBounds(true);
            tmp.setScale(.7)
            // Set the width and height of the player sprite
            // tmp.displayWidth = 48; // Set width to 64 pixels
            // tmp.displayHeight = 48; // Set height to 64 pixels
            playerSprites[playerType].userNameTextPos = this.add.text(
                tmp.x - userNameOffSetX,
                tmp.y - userNameOffSetY, '', {
                    fontFamily: 'Arial',
                    fontSize: 12,
                    color: '#ffffff'
                });

            tmp.id = playerType
            // attach player info
            playerSprites[playerType].playerInfo = tmp
        }
    }

    function update() {
        const tmp = allPlayers[userId]
        // initial empty because websocket is requesting info
        if (tmp === undefined) {
            console.log('waiting for player info')
            return
        }

        let currentPlayerSpriteType = allPlayers[userId].spriteType
        // anims
        const neutralAnim = playerSprites[currentPlayerSpriteType].defaultAnim
        const anim = playerSprites[currentPlayerSpriteType].animBase
        let curAnim;

        if (cursors.left.isDown) {
            // remove vertical velocity
            playerSprites[currentPlayerSpriteType].playerInfo.setVelocityY(0);
            playerSprites[currentPlayerSpriteType].playerInfo.setVelocityX(movementSpeed);
            // set anim
            curAnim = `${anim}West`
            setSpriteAnim(playerSprites[currentPlayerSpriteType].playerInfo, curAnim)

        } else if (cursors.right.isDown) {
            // remove vertical velocity
            playerSprites[currentPlayerSpriteType].playerInfo.setVelocityY(0);
            playerSprites[currentPlayerSpriteType].playerInfo.setVelocityX(-movementSpeed);

            curAnim = `${anim}East`
            setSpriteAnim(playerSprites[currentPlayerSpriteType].playerInfo, curAnim)
        } else if (cursors.up.isDown) {
            // remove horizontal velocity
            playerSprites[currentPlayerSpriteType].playerInfo.setVelocityX(0);
            playerSprites[currentPlayerSpriteType].playerInfo.setVelocityY(movementSpeed);

            curAnim = `${anim}North`
            setSpriteAnim(playerSprites[currentPlayerSpriteType].playerInfo, curAnim)
        } else if (cursors.down.isDown) {
            // remove horizontal velocity
            playerSprites[currentPlayerSpriteType].playerInfo.setVelocityX(0);
            playerSprites[currentPlayerSpriteType].playerInfo.setVelocityY(-movementSpeed);

            curAnim = `${anim}South`
            setSpriteAnim(playerSprites[currentPlayerSpriteType].playerInfo, curAnim)
        } else {
            playerSprites[currentPlayerSpriteType].playerInfo.setVelocityY(0);
            playerSprites[currentPlayerSpriteType].playerInfo.setVelocityX(0);

            curAnim = neutralAnim
            setSpriteAnim(playerSprites[currentPlayerSpriteType].playerInfo, curAnim, false)
        }

        // move username text
        setUserNameTextPos(currentPlayerSpriteType)

        // setup info to send to server
        allPlayers[userId].x = playerSprites[currentPlayerSpriteType].playerInfo.x
        allPlayers[userId].y = playerSprites[currentPlayerSpriteType].playerInfo.y
        allPlayers[userId].spriteAnim = curAnim


        socket.emit('pos', JSON.stringify(allPlayers[userId]))
    }

    function setSpriteAnim(sprite, anim, loop = true) {
        // convert loop to bool
        sprite.anims.play(anim, loop)
    }

    function pacmanAnimInit(ctx) {
        let namesArray = [
            'pacmanEast',
            'pacmanNorth',
            'pacmanSouth',
            'pacmanWest',
        ]
        let indexArray = 0
        for (let i = 0; i < 12; i += 3) {
            ctx.anims.create({
                frames: ctx.anims.generateFrameNumbers('pacman', {start: i + 1, end: i + 3}),
                key: namesArray[indexArray],
                frameRate: 10,
                repeat: -1
            });
            indexArray++
        }

        // neutral pacman
        ctx.anims.create({
            frames: ctx.anims.generateFrameNumbers('pacman', {start: 0, end: 0}),
            key: 'pacmanDefault',
            frameRate: 1,
            repeat: -1
        });

    }

    function createMap(ctx) {
        const map = ctx.make.tilemap({key: 'map'})

        const blueTile = map.addTilesetImage('secondTile', 'secondTile')
        const redTile = map.addTilesetImage('forthTile', 'forthTile')
        const pellets = map.addTilesetImage('centrepoint', 'centrepoint')

        mapLayer = map.createLayer('map', [blueTile, redTile])
        pelletLayer = map.createLayer('pellets', pellets)

        if (mapLayer === null || pelletLayer === null) {
            throw Error('Map layer or pellet layer failed to initlize')
        }

        mapLayer.setCollisionByExclusion([-1], true, true)
        pelletLayer.setCollisionByExclusion([-1])
    }

    function pelletCallBack(pacman, pellet) {
        pelletLayer.removeTileAt(pellet.x, pellet.y)
        console.log(pelletLayer.tilesDrawn)

    }

    function setUserNameTextPos(spriteId) {
        playerSprites[spriteId]
            .userNameTextPos
            .setPosition(
                playerSprites[spriteId].playerInfo.x - userNameOffSetX,
                playerSprites[spriteId].playerInfo.y - userNameOffSetY
            );
    }

    function setUserNameText(spriteId, text) {
        if (playerSprites[spriteId].userNameTextPos === null) {
            console.log('Client is not ready yet to set username text')
            return
        }
        playerSprites[spriteId].userNameTextPos.setText(text);
    }

    function ghostsAnimInit(ctx) {
        let namesArray = [
            'ghostRedEast',
            'ghostRedNorth',
            'ghostRedSouth',
            'ghostRedWest',
            'ghostBlueEast',
            'ghostBlueNorth',
            'ghostBlueSouth',
            'ghostBlueWest',
            'ghostPinkEast',
            'ghostPinkNorth',
            'ghostPinkSouth',
            'ghostPinkWest',
            'frigthenedAnim',
        ]
        for (let i = 0; i < namesArray.length; i++) {
            ctx.anims.create({
                frames: ctx.anims.generateFrameNumbers('ghosts', {start: i, end: i}),
                key: namesArray[i],
            })
        }
    }


</script>

<div id="thegame"></div>

</body>
</html>`