<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    <script src="https://cdn.socket.io/4.3.1/socket.io.min.js"></script>
    <title>Lets play a game</title>
</head>
<body>
<script>
    const lobbyId = "{{lobby}}";
    const userId = "{{user}}";

    let allPlayers = {};

    const socket = io();

    // default socket io connection message
    socket.on('connect', () => {
        socket.emit('join', {'lobbyId': lobbyId, 'userId': userId})
        console.log('Connected')
    })

    // custom connection message used by the project
    socket.on('set', handleJoin)
    socket.on('pos', handlePos)
    socket.on('dis', handleDis)
    socket.on('pellet', function (msg) {
        console.log('Pellet eaten')
    })

    function handleJoin(msg) {
        let json = JSON.parse(msg);
        if (!json.spriteType) {
            throw new DOMException("No sprite id found")
        }
        allPlayers[json.playerid] = json
    }

    function handleDis(msg) {
        const json = JSON.parse(msg);
        console.log('disconnect')
        console.log(json.playerid)
        delete allPlayers[json.playerid]
    }

    function handlePos(msg) {
        let json = JSON.parse(msg);
        let spriteId = json.spriteType
        // update player
        allPlayers[json.id] = json

        // update other player sprites
        playerSprites[spriteId][0].x = json.x
        playerSprites[spriteId][0].y = json.y
        try {
            playerSprites[spriteId][0].anims.play(json.spriteAnim, true)
        } catch (e) {
            // if invalid anim default to neutral image
            playerSprites[spriteId][0].anims.play()
        }
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // main game
    let cursors;

    // mapped sprite id with:
    // playerInfo
    // default anim
    // anim base so that we can add direction
    // start pos : {x, y}
    let playerSprites = {
        'pcm': [null, 'pacmanDefault', 'pacman', [400, 100]],
        'gh1': [null, 'ghostRedNorth', 'ghostRed', [400, 200]],
        'gh2': [null, 'ghostBlueNorth', 'ghostBlue', [400, 300]],
        'gh3': [null, 'ghostPinkNorth', 'ghostPink', [400, 400]],
    }

    const config = {
        type: Phaser.AUTO,
        width: 1200,
        height: 720,
        backgroundColor: 0x000000,
        physics: {
            default: 'arcade',
            arcade: {
                gravity: 0,
                debug: true
            }
        },
        scale: {
            mode: Phaser.Scale.FIT,
            autoCenter: Phaser.Scale.CENTER_BOTH,
            parent: 'thegame'

        },
        pixelArt: true,
        scene: {
            preload: preload,
            create: create,
            update: update
        }
    };

    const game = new Phaser.Game(config);

    function preload() {
        // sprite sheets
        this.load.spritesheet("pacman", "assets/pacmanSpriteSheet.png", {
            frameWidth: 50,
            frameHeight: 50,
        });
        this.load.spritesheet("ghosts", "assets/ghosts.png", {
            frameWidth: 50,
            frameHeight: 50,
        });
        this.load.spritesheet("fruits", "assets/fruits.png", {
            frameWidth: 50,
            frameHeight: 50,
        });

        this.load.tilemapTiledJSON('map',"map.json");
    }

    function create() {
        // keyboard detect
        cursors = this.input.keyboard.createCursorKeys();

        // Create purple borders
        const borderThickness = 10;
        const borderGraphics = this.add.graphics();
        borderGraphics.lineStyle(borderThickness, 0x800080, 1); // Purple color
        borderGraphics.strokeRect(borderThickness / 2, borderThickness / 2, config.width - borderThickness, config.height - borderThickness);


        // create animations
        pacmanAnimInit(this)
        ghostsAnimInit(this)

        // load in initial sprites
        for (let playerType in playerSprites) {
            const sprite = playerSprites[playerType]
            const defaultAnim = sprite[1]
            const startPos = sprite[3]

            let tmp = this.physics.add.sprite(
                startPos[0],
                startPos[1],
                playerType === 'pcm' ? 'pacman' : 'ghosts'
            );

            tmp.anims.play(defaultAnim);
            tmp.setOrigin(0.5);
            tmp.setCollideWorldBounds(true);

            // Set the width and height of the player sprite
            // tmp.displayWidth = 48; // Set width to 64 pixels
            // tmp.displayHeight = 48; // Set height to 64 pixels

            tmp.id = playerType
            // attach player info
            playerSprites[playerType][0] = tmp
        }
    }

    function update() {
        const tmp = allPlayers[userId]
        // initial empty because websocket is requesting info
        if (tmp === undefined) {
            console.log('waiting for player info')
            return
        }

        let currentPlayerSpriteType = allPlayers[userId].spriteType
        // anims
        const neutralAnim = playerSprites[currentPlayerSpriteType][1]
        const anim = playerSprites[currentPlayerSpriteType][2]
        let curAnim = neutralAnim
        // movement
        let movementSpeed = -160

        if (cursors.left.isDown) {
            // remove vertical velocity
            playerSprites[currentPlayerSpriteType][0].setVelocityY(0);
            playerSprites[currentPlayerSpriteType][0].setVelocityX(movementSpeed);
            // set anim
            curAnim = `${anim}West`
            setSpriteAnim(playerSprites[currentPlayerSpriteType][0], curAnim)

        } else if (cursors.right.isDown) {
            // remove vertical velocity
            playerSprites[currentPlayerSpriteType][0].setVelocityY(0);
            playerSprites[currentPlayerSpriteType][0].setVelocityX(-movementSpeed);

            curAnim = `${anim}East`
            setSpriteAnim(playerSprites[currentPlayerSpriteType][0], curAnim)
        } else if (cursors.up.isDown) {
            // remove horizontal velocity
            playerSprites[currentPlayerSpriteType][0].setVelocityX(0);
            playerSprites[currentPlayerSpriteType][0].setVelocityY(movementSpeed);

            curAnim = `${anim}North`
            setSpriteAnim(playerSprites[currentPlayerSpriteType][0], curAnim)
        } else if (cursors.down.isDown) {
            // remove horizontal velocity
            playerSprites[currentPlayerSpriteType][0].setVelocityX(0);
            playerSprites[currentPlayerSpriteType][0].setVelocityY(-movementSpeed);

            curAnim = `${anim}South`
            setSpriteAnim(playerSprites[currentPlayerSpriteType][0], curAnim)
        } else {
            playerSprites[currentPlayerSpriteType][0].setVelocityY(0);
            playerSprites[currentPlayerSpriteType][0].setVelocityX(0);

            curAnim = neutralAnim
            setSpriteAnim(playerSprites[currentPlayerSpriteType][0], curAnim, false)
        }

        allPlayers[userId].x = playerSprites[currentPlayerSpriteType][0].x
        allPlayers[userId].y = playerSprites[currentPlayerSpriteType][0].y
        allPlayers[userId].spriteAnim = curAnim

        socket.emit('pos', JSON.stringify(allPlayers[userId]))
    }

    function setSpriteAnim(sprite, anim, loop = true) {
        // convert loop to bool
        sprite.anims.play(anim, loop)
    }

    function pacmanAnimInit(ctx) {
        let namesArray = [
            'pacmanEast',
            'pacmanNorth',
            'pacmanSouth',
            'pacmanWest',
        ]
        let indexArray = 0
        for (let i = 0; i < 12; i += 3) {
            ctx.anims.create({
                frames: ctx.anims.generateFrameNumbers('pacman', {start: i + 1, end: i + 3}),
                key: namesArray[indexArray],
                frameRate: 10,
                repeat: -1
            });
            indexArray++
        }

        // neutral pacman
        ctx.anims.create({
            frames: ctx.anims.generateFrameNumbers('pacman', {start: 0, end: 0}),
            key: 'pacmanDefault',
            frameRate: 1,
            repeat: -1
        });

    }

    function ghostsAnimInit(ctx) {
        let namesArray = [
            'ghostRedEast',
            'ghostRedNorth',
            'ghostRedSouth',
            'ghostRedWest',
            'ghostBlueEast',
            'ghostBlueNorth',
            'ghostBlueSouth',
            'ghostBlueWest',
            'ghostPinkEast',
            'ghostPinkNorth',
            'ghostPinkSouth',
            'ghostPinkWest',
            'frigthenedAnim',
        ]
        for (let i = 0; i < namesArray.length; i++) {
            ctx.anims.create({
                frames: ctx.anims.generateFrameNumbers('ghosts', {start: i, end: i}),
                key: namesArray[i],
            })
        }
    }


</script>

<div id="thegame"></div>

</body>
</html>`